#!/bin/bash

# PodPod FastAPI 서버 시작 스크립트

# 현재 디렉토리 확인
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# 가상환경 경로
VENV_PATH="./venv"

# 가상환경이 존재하는지 확인
if [ ! -d "$VENV_PATH" ]; then
    echo "가상환경 'venv'를 찾을 수 없습니다."
    echo "가상환경을 자동으로 생성합니다..."
    python3 -m venv venv
    
    if [ $? -ne 0 ]; then
        echo "가상환경 생성에 실패했습니다."
        echo "수동으로 다음 명령어를 실행하세요:"
        echo "python3 -m venv venv"
        exit 1
    fi
    
    echo "가상환경이 성공적으로 생성되었습니다."
    echo "필요한 패키지들을 설치합니다..."
    "$VENV_PATH/bin/pip" install -r requirements.txt
    
    if [ $? -ne 0 ]; then
        echo "패키지 설치에 실패했습니다."
        exit 1
    fi
    
    echo "패키지 설치가 완료되었습니다."
fi

# 가상환경의 Python 경로
PYTHON_PATH="$VENV_PATH/bin/python3"

# 가상환경의 Python이 존재하는지 확인
if [ ! -f "$PYTHON_PATH" ]; then
    echo "가상환경 Python 실행 파일을 찾을 수 없습니다: $PYTHON_PATH"
    exit 1
fi

echo "가상환경 Python 사용: $PYTHON_PATH"

# 가상환경의 Python으로 run.py 실행
exec "$PYTHON_PATH" run.py "$@"
